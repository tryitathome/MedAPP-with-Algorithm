# 报告查看与保存页面更新说明

## 概述

本次更新修改了"详细报告"页面中的"检测结果概览"部分，使其能够根据检测模式（二分类 vs 三分类）显示不同的内容和格式。

## 修改内容

### 1. ReportModal 组件更新

**文件位置**: `src/components/oral/modals/ReportModal.tsx`

#### 新增 Props 参数
- `deepDetectionResults?: DeepDetectionResults | null` - 深度检测结果数据
- `selectedImage?: string | null` - 原始上传图片的URL
- `isDeepMode?: boolean` - 是否为深度检测模式标识

#### 检测结果概览逻辑更新

**二分类模式（基本检测）**：
- 显示原始上传的图片
- 显示两个置信度条：
  - 健康或其他良性疾病 (Benign) - 绿色进度条
  - 恶性或潜在恶性疾病 (OPMD) - 红色进度条
- 置信度数据来源：
  - 优先使用 `diagnosisResponse.data.results.predicted_class` 和 `confidence`
  - 回退到旧的 `OPMD` 字段

**三分类模式（深度检测）**：
- 显示带检测框的叠加图片（来自深度检测结果）
- 显示四个置信度条：
  - 口腔白斑病 (OLK) - 黄色进度条
  - 口腔扁平苔藓 (OLP) - 蓝色进度条  
  - 口腔黏膜下纤维性变 (OSF) - 紫色进度条
  - 口腔潜在恶性疾病 (OPMD) - 红色进度条

### 2. OralDiagnosisInterface 组件更新

**文件位置**: `src/components/oral/OralDiagnosisInterface.tsx`

#### ReportModal 调用更新
在 ReportModal 组件调用时新增了三个参数：
```tsx
<ReportModal 
  // ... 原有参数
  deepDetectionResults={deepDetectionResults}
  selectedImage={selectedImage}
  isDeepMode={deepMode}
/>
```

## UI 设计细节

### 图片显示
- **容器设计**: 最大宽度适中，带圆角边框
- **图片处理**: 
  - 最大高度限制为 256px (16rem)
  - 保持宽高比 (object-contain)
  - 错误处理：加载失败时显示占位符和错误信息

### 置信度条设计
- **二分类模式**: 2列网格布局，较大的显示框
- **三分类模式**: 2x2网格布局，紧凑的显示框
- **进度条**: 
  - 高度适中（二分类: 8px, 三分类: 6px）
  - 平滑动画过渡效果
  - 颜色区分不同类别

### 响应式布局
- 在移动设备上自动调整网格布局
- 图片和进度条适配不同屏幕尺寸
- 保持可读性和美观性

## 数据流

```
1. 用户点击"详细报告"按钮
2. OralDiagnosisInterface 传递当前状态数据给 ReportModal
3. ReportModal 根据 isDeepMode 标识选择显示模式
4. 如果是深度模式，显示 deepDetectionResults 的数据和图片
5. 如果是基本模式，显示 selectedImage 和 diagnosisResponse 的数据
```

## 错误处理

### 图片加载失败
- 显示错误占位符
- 在控制台输出详细错误信息
- 图片透明度降低以表示错误状态

### 数据缺失处理
- 置信度数据缺失时使用默认值 (0.5)
- 图片URL无效时显示"不可用"提示
- 深度检测结果为空时优雅降级

## 兼容性保证

### 向后兼容
- 保留所有原有的 Props 参数
- 新增参数均为可选参数，有默认值
- 不影响其他组件的现有调用方式

### 数据格式兼容
- 支持新的 `predicted_class` + `confidence` 格式
- 回退到旧的 `OPMD` 字段格式
- 处理各种数据缺失情况

## 测试建议

### 功能测试
1. **二分类模式测试**:
   - 上传图片进行基本检测
   - 查看详细报告，确认显示原始图片
   - 验证两个置信度条显示正确

2. **三分类模式测试**:
   - 进行深度检测
   - 查看详细报告，确认显示带检测框的图片
   - 验证四个置信度条显示正确

3. **边界情况测试**:
   - 图片加载失败的情况
   - 数据缺失的情况
   - 网络连接问题

### 视觉测试
- 在不同屏幕尺寸下检查布局
- 验证颜色和样式一致性
- 确认动画效果流畅

## 部署注意事项

### 环境变量
确保 `NEXT_PUBLIC_API_URL` 正确配置，用于深度检测图片的URL构建。

### 静态资源
深度检测的叠加图片需要后端正确返回可访问的URL路径。

---

*更新时间: 2025年9月10日*
*更新人员: AI Assistant*
